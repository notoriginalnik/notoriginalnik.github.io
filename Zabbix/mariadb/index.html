<!--
  This Basic theme serves as an example for how to create other
  themes by demonstrating the features with minimal HTML and CSS.
  Comments like this will be through the code to explain briefly
  what each feature is and point you to the MkDocs documentation
  to find out more.
-->
<!DOCTYPE html>
<head>
  
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <!--
    The page_title contains the title for a page as shown in the navigation.
    Site name contains the name as defined in the mkdocs.yml
  -->
  
  <title>Install mariadb node of galera + haproxy + keepalived - not name</title>
  
  <!--
    You can include external assets of course, but be aware that it means the
    documentation may not work well offline.
  -->
  <link rel="stylesheet" href="../../css/pure-min.css">
  <link rel="stylesheet" href="../../css/theme.css">

  <!--
    extra_ess contains paths to CSS files in the users
    documentation directory or a list of CSS files defined in
    their mkdocs.yml.

    http://www.mkdocs.org/user-guide/configuration/#extra_css
  -->
   
  
  
  
  
  
  
</head>

<body>

  <!--
  <h1>This is an example theme for MkDocs.</h1>

  <p>
    It is designed to be read by looking at the theme HTML which is heavily
    commented. The easiest way to do that is by
    <strong><a href="https://github.com/mkdocs/mkdocs-basic-theme/tree/master/basic_theme">
    looking at the source on GitHub.</a></strong>. Otherwise this is just a
    demonstration that the theme is fully functional.
  </p>

  <hr/>
  -->
  <!--
  <h2>Documentation Navigation</h2>
  -->
  <!--
    Create the navigation for the documentation.

    Because we don't know how many levels deep the navigation is, it needs to
    be included in it's own file so it can be recursive. Otherwise the theme
    can also only support a specific number of levels.

    See the nav.html file for more details about how this works.
  -->
  

<div id="layout">

    <!-- Menu toggle -->
  <h1 class="logo-text">
	<label for="toggler">
      <i class="fas fa-bars sidebar-toggle"></i>
    </label>
  </h1>
	
	<input type="checkbox" id="toggler"/>
    <div id="menu">
      <div class="pure-menu">
	  <a class="pure-menu-heading" href="../..">Home</a>
  <ul class="pure-menu-list">
  
    <!--

-->

  <li class="pure-menu-folder">
    Тренировки
    <ul>
        
            <!--

-->

<li >
    <a href="../../%D0%A2%D1%80%D0%B5%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8/%D0%A1%D0%B8%D0%BB%D0%BE%D0%B2%D1%8B%D0%B5%20%D1%82%D1%80%D0%B5%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8/" class="pure-menu-link">Силовые тренировки</a>
</li>

        
            <!--

-->

<li >
    <a href="../../%D0%A2%D1%80%D0%B5%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8/%D0%B2%D0%BE%D1%81%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5/" class="pure-menu-link">Восстановление</a>
</li>

        
            <!--

-->

<li >
    <a href="../../%D0%A2%D1%80%D0%B5%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8/%D0%B7%D0%B0%D1%80%D1%8F%D0%B4%D0%BA%D0%B0/" class="pure-menu-link">Зарядка</a>
</li>

        
            <!--

-->

<li >
    <a href="../../%D0%A2%D1%80%D0%B5%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8/%D1%80%D0%B0%D1%81%D1%82%D1%8F%D0%B6%D0%BA%D0%B0/" class="pure-menu-link">Растяжка</a>
</li>

        
    </ul>
  </li>

  
    <!--

-->

  <li class="pure-menu-folder">
    Поход
    <ul>
        
            <!--

-->

<li >
    <a href="../../%D0%9F%D0%BE%D1%85%D0%BE%D0%B4/%D0%93%D0%B8%D0%B3%D0%B8%D0%B5%D0%BD%D0%B0/" class="pure-menu-link">Гигиена</a>
</li>

        
            <!--

-->

<li >
    <a href="../../%D0%9F%D0%BE%D1%85%D0%BE%D0%B4/%D0%94%D0%BE%D0%BB%D0%B6%D0%BD%D0%BE%D1%81%D1%82%D0%B8/" class="pure-menu-link">Должности</a>
</li>

        
            <!--

-->

<li >
    <a href="../../%D0%9F%D0%BE%D1%85%D0%BE%D0%B4/%D0%9F%D0%B8%D1%82%D0%B0%D0%BD%D0%B8%D0%B5/" class="pure-menu-link">Питание</a>
</li>

        
    </ul>
  </li>

  
    <!--

-->

  <li class="pure-menu-folder">
    Питание
    <ul>
        
            <!--

-->

<li >
    <a href="../../%D0%9F%D0%B8%D1%82%D0%B0%D0%BD%D0%B8%D0%B5/%D0%91%D0%96%D0%A3/" class="pure-menu-link">БЖУ</a>
</li>

        
            <!--

-->

<li >
    <a href="../../%D0%9F%D0%B8%D1%82%D0%B0%D0%BD%D0%B8%D0%B5/%D0%9C%D0%B8%D0%BD%D0%B5%D1%80%D0%B0%D0%BB%D1%8B/" class="pure-menu-link">Минералы</a>
</li>

        
            <!--

-->

<li >
    <a href="../../%D0%9F%D0%B8%D1%82%D0%B0%D0%BD%D0%B8%D0%B5/%D0%B2%D0%B8%D1%82%D0%B0%D0%BC%D0%B8%D0%BD%D0%BA%D0%B8/" class="pure-menu-link">Витаминки</a>
</li>

        
    </ul>
  </li>

  
    <!--

-->

  <li class="pure-menu-folder">
    Компьютер
    <ul>
        
            <!--

-->

<li >
    <a href="../../%D0%9A%D0%BE%D0%BC%D0%BF%D1%8C%D1%8E%D1%82%D0%B5%D1%80/%D0%BA%D0%BE%D0%BC%D0%BF%D1%8C%D1%8E%D1%82%D0%B5%D1%80/" class="pure-menu-link">Компьютер</a>
</li>

        
    </ul>
  </li>

  
    <!--

-->

  <li class="pure-menu-folder">
    Кинокаталог
    <ul>
        
            <!--

-->

<li >
    <a href="../../%D0%9A%D0%B8%D0%BD%D0%BE%D0%BA%D0%B0%D1%82%D0%B0%D0%BB%D0%BE%D0%B3/%D0%9C%D1%83%D0%BB%D1%8C%D1%82%D1%84%D0%B8%D0%BB%D1%8C%D0%BC%D1%8B/" class="pure-menu-link">Мультфильмы</a>
</li>

        
            <!--

-->

<li >
    <a href="../../%D0%9A%D0%B8%D0%BD%D0%BE%D0%BA%D0%B0%D1%82%D0%B0%D0%BB%D0%BE%D0%B3/%D0%A4%D0%B8%D0%BB%D1%8C%D0%BC%D1%8B/" class="pure-menu-link">Фильмы</a>
</li>

        
    </ul>
  </li>

  
    <!--

-->

  <li class="pure-menu-folder">
    Useful programs
    <ul>
        
            <!--

-->

<li >
    <a href="../../useful_programs/" class="pure-menu-link">opensource programms</a>
</li>

        
    </ul>
  </li>

  
    <!--

-->

  <li class="pure-menu-folder">
    Zabbix
    <ul>
        
            <!--

-->

<li >
    <a href="../Partitioning/" class="pure-menu-link">Partitioning with external script for mysql/mariadb database</a>
</li>

        
            <!--

-->

<li >
    <a href="../SSO/" class="pure-menu-link">SSO in zabbix</a>
</li>

        
            <!--

-->

<li >
    <a href="../linux_template/" class="pure-menu-link">linux template</a>
</li>

        
            <!--

-->

<li class="pure-menu-item">
    <a href="./" class="pure-menu-link">Install mariadb node of galera + haproxy + keepalived</a>
</li>

        
            <!--

-->

<li >
    <a href="../mysql_monitoring/" class="pure-menu-link">Monitoring mysql/mariadb</a>
</li>

        
            <!--

-->

<li >
    <a href="../zabbix-agent/" class="pure-menu-link">install [zabbix-agent]</a>
</li>

        
            <!--

-->

<li >
    <a href="../zabbix-proxy/" class="pure-menu-link">Zabbix-proxy</a>
</li>

        
    </ul>
  </li>

  
    <!--

-->

  <li class="pure-menu-folder">
    Browser
    <ul>
        
            <!--

-->

<li >
    <a href="../../Browser/ublock/" class="pure-menu-link">Ublock</a>
</li>

        
            <!--

-->

<li >
    <a href="../../Browser/%D0%98%D0%B7%D0%BC%D0%B5%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81%D0%B0/" class="pure-menu-link">Изменение интерфейса</a>
</li>

        
    </ul>
  </li>

  
    <!--

-->

<li >
    <a href="../.." class="pure-menu-link">Home</a>
</li>

  
  </ul>
      </div>
    </div>




<div id="main">
  <div class="content">
    
        <h1 id="install-mariadb-node-of-galera-haproxy-keepalived">Install mariadb node of galera + haproxy + keepalived</h1>
<p>Easy playbook for this:</p>
<pre><code>- name: INSTALLATION
  hosts: testcluster
  gather_facts: no
  roles:
#    - prerequest
    - rh_mariadb_install
    - firewalld
    - haproxy_keepalived

  handlers:
    - include: handlers/main.yml
</code></pre>
<p>And lets go!</p>
<details>
  <summary>
    j2 config for rh-mariadb102-mariadb
  </summary>

<pre><code class="language-conf">[mysqld]
datadir=/home/opt/rh/rh-mariadb102/lib/mysql
socket=/var/lib/mysql/mysql.sock
log-error=/home/opt/rh/rh-mariadb102/log/mariadb/mariadb.log
pid-file=/run/rh-mariadb102-mariadb/mariadb.pid
character-set-server=utf8

# network
connect_timeout = 60
wait_timeout = 28800
interactive_timeout = 28800
max_connections = 200
max_connect_errors = 100
max_allowed_packet = 128M

event_scheduler = ON
back_log = 50 

# innodb
default_storage_engine=InnoDB
innodb_file_per_table = 1
innodb_log_buffer_size = 128M
innodb_log_file_size = 512M
innodb_log_files_in_group = 3
innodb_buffer_pool_size = 6G

[galera]
wsrep_on=ON
wsrep_provider=/opt/rh/rh-mariadb102/root/usr/lib64/galera/libgalera_smm.so

#U must change this after installation
wsrep_cluster_address=gcomm://

binlog_format=row
default_storage_engine=InnoDB
innodb_autoinc_lock_mode=2
bind-address=0.0.0.0
wsrep_cluster_name=&quot;Cluster&quot;
wsrep_node_address={{ inventory_hostname }}
wsrep_sst_method=rsync
</code></pre>

</details>

<details>
  <summary>role rh_mariadb_install:</summary>

<pre><code class="language-yml">- name: Install
  block:
    - name: install centos-release
      yum:
        name: 
          - centos-release-scl-rh
          - centos-release-scl
        state: present

    - name: install mariadb102
      yum:
        name:
        - rh-mariadb102-mariadb-server
        - rh-mariadb102-mariadb-server-galera
        enablerepo: centos-sclo-rh
        state: present
      notify:     
        - add utf8 into mysqld section
        - copy var in home
        - move galera.cnf    

# ansible cant create normal file in directory /etc/profile.d/
# ansible stops on command 'scl enable rh-mariadb102' bash because that invoke subshell
# ansible not change environmnet variables in session, even 'source /opt/rh/rh-mariadb102/enable' not work
    - name: COPY rh-mariadb102.sh
      copy:
        src: &quot;{{ item.source }}&quot;
        dest: &quot;{{ item.dest }}&quot;
#        owner: root
#        group: root
      loop:
#         - { source: 'templates/rh-mariadb102.sh', dest: '/etc/profile.d/rh-mariadb102.sh' }
         - { source: 'templates/mysql_secure_installation.sql', dest: '/etc/my.cnf.d/mysql_secure_installation.sql' }
#      notify:
#        - enable rh-mariadb102 bash 
#        - start rh-mariadb102-mariadb 

    - name: COPY mariadb-server.cnf
      template:
        src: &quot;{{ item.source }}&quot;
        dest: &quot;{{ item.dest }}&quot;
        owner: root
        group: root
      loop:
         - { source: 'templates/mariadb-server.j2', dest: '/etc/opt/rh/rh-mariadb102/my.cnf.d/mariadb-server.cnf' }

#    - name: start rh-mariadb102-mariadb
#      service:
#        name: rh-mariadb102-mariadb
#        state: started
#        enabled: yes
#      ignore_errors: yes

#    - name: auto secure-install mysql
#      shell: mysql -sfu root &lt; /etc/my.cnf.d/mysql_secure_installation.sql

  ignore_errors: yes
</code></pre>

</details>

<details>
  <summary>role firewalld:</summary>

<pre><code class="language-yml">- name: firewall
  block:
    - name: start firewalld
      service:
        name: firewalld
        state: started
        enabled: yes

    - name: mysql firewalld
      firewalld:
        service: mysql
        permanent: true
        state: enabled

    - name: ports firewalld
      firewalld:
        port: &quot;{{ item.port }}/tcp&quot;
        permanent: true
        state: enabled
      loop:
         - { port: 3306 }
         - { port: 4567 }
         - { port: 4568 }
         - { port: 4444 }
      notify: firewall reload


  ignore_errors: yes
</code></pre>

</details>

<details><summary>j2 config for haproxy:</summary>

<pre><code class="language-conf">#The connect option specifies the maximum time to wait for a connection attempt to a VPS to succeed.
#The client and server timeouts apply when the client or server is expected to acknowledge or send data during the TCP process. 
#HAProxy recommends setting the client and server timeouts to the same value.

The retries directive sets the number of retries to perform on a VPS after a connection failure.
frontend mariadb
bind {{ inventory_hostname }}:3307
timeout connect 30m
timeout client 3h
timeout server 3h
mode tcp
default_backend mariadb_galera
backend mariadb_galera
balance source
mode tcp
option tcpka
timeout connect 30m
timeout client 3h
timeout server 3h
option mysql-check user haproxy
server HOSTNAME IPADDRESS:3306 check weight 1
server HOSTNAME IPADDRESS:3306 check weight 1
server HOSTNAME IPADDRESS:3306 check weight 1
</code></pre>

</details>

<details><summary>j2 config for keepalived:</summary>

<pre><code class="language-conf">global_defs {
router_id HOSTNAME
}
vrrp_script haproxy {
script &quot;killall -0 haproxy&quot; 
interval 2
weight 2
}
vrrp_instance 50 {
virtual_router_id 50
advert_int 1
priority 90
state BACKUP
interface ens192
virtual_ipaddress {
VIRTUAL_IPADDRESS dev ens192
}
track_script {
haproxy
}
}
</code></pre>

</details>

<details><summary>role haproxy_keepalived:</summary>


<pre><code class="language-yml">- name: Install haproxy and keepalived
  block:
    - name: install haproxy and keepalived
      yum:
        name: 
          - haproxy
          - keepalived
        enablerepo: centos-sclo-rh
        state: present

    - name: COPY configs
      template:
        src: &quot;{{ item.source }}&quot;
        dest: &quot;{{ item.dest }}&quot;
        owner: root
        group: root
      loop:
         - { source: 'templates/keepalived.j2', dest: '/etc/keepalived/keepalived.conf' }
         - { source: 'templates/haproxy.j2', dest: '/etc/haproxy/haproxy.cfg' }

##need add two strings in /etc/sysctl.conf https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/load_balancer_administration/s1-initial-setup-forwarding-vsa
#net.ipv4.ip_forward = 1
#net.ipv4.ip_nonlocal_bind = 1
##Apply changes:
#sysctl -p
#https://packetpushers.net/vrrp-linux-using-keepalived-2/
  ignore_errors: yes
</code></pre>

</details>

<details><summary>handlers:</summary>

<pre><code>- name: save iptables
  shell: iptables-save &gt; /etc/sysconfig/iptables
  ignore_errors: yes

- name: start zabbix-agent
  service:
    name: zabbix-agent
    state: started
  ignore_errors: yes

- name: enable zabbix-agent
  command: chkconfig zabbix-agent on

- name: add utf8 into mysqld section
  shell: sed -i '/mysqld]/a character-set-server=utf8' /etc/opt/rh/rh-mariadb102/my.cnf.d/mariadb-server.cnf

- name: firewall reload
  systemd:
    name: firewalld
    state: reloaded

- name: move galera.cnf 
  shell: mv /etc/opt/rh/rh-mariadb102/my.cnf.d/galera.cnf /etc/opt/rh/rh-mariadb102/my.cnf.d/galera.cnf.org

#change database directory to home
- name: copy var in home
  shell: cp -pR /var/opt /home/opt

# Not works
#- name: enable rh-mariadb102 bash
#  shell: /etc/profile.d/rh-mariadb102.sh
#  shell: scl enable rh-mariadb102 bash
#  shell: source /opt/rh/rh-mariadb102/enable
</code></pre>

</details>

<p>Use <code>scl enable rh-mariadb102 bash</code> for export evironment variables.(or <code>source /opt/rh/rh-mariadb102/enable</code>)
For save this variables after restart, create <code>/etc/profile.d/rh-mariadb102.sh</code>.
This file not works if created in playbook (idk why?) </p>
<pre><code class="language-sh"># create new
source /opt/rh/rh-mariadb102/enable
export X_SCLS=&quot;`scl enable rh-mariadb102 'echo $X_SCLS'`&quot;
</code></pre>
<p>Happy end, or not</p>
<pre><code class="language-sh"># Need for haproxy
echo &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt; /etc/sysctl.conf
echo &quot;net.ipv4.ip_nonlocal_bind = 1&quot; &gt;&gt; /etc/sysctl.conf
sysctl -p

# Maria run
service rh-mariadb102-mariadb start
systemctl enable rh-mariadb102-mariadb
mysql -sfu root &lt; /etc/my.cnf.d/mysql_secure_installation.sql

#Need import database scheme and backup of database
mkdir /backup
yum install cifs-utils
vi /etc/fstab
mount -a
zcat /backup/zabbix-server-mysql/create.sql.gz | mysql -uroot -p
gunzip &lt; /backup/zabbix_backup_without_history.sql.gz | mysql -uroot -p

# Pul all nodes in hosts
vi /etc/hosts
# set hostname
hostnamectl set-hostname zabbixdb

#There can be surprise with logs of maria
mkdir /var/log/mysql
chmod 777 /var/log/mysql

# last change config to production and restart
vi /etc/opt/rh/rh-mariadb102/my.cnf.d/mariadb-server.cnf
service rh-mariadb102-mariadb stop
service rh-mariadb102-mariadb start
</code></pre>
    
    



  <!--  
  <h2>Next and previous links</h2>

    Implement the previous and next links to cycle through the pages.
  -->

    
    
    <nav class="pagination">
      
        <a href="../linux_template/" class="pagination--pager" title="linux template">&laquo; Previous</a>
      
      
      
        <a href="../mysql_monitoring/"  class="pagination--pager" title="Monitoring mysql/mariadb"/>Next &raquo;</a>
      
    </nav>
    
    



  <!--
    Support repo URL
  -->
  
  
   Built on <a href="https://github.com/notoriginalnik/notoriginalnik.github.io">GitHub</a>
  
  
  
   with <a href="https://www.mkdocs.org">MkDocs</a> and <a href="https://github.com/notoriginalnik/mkdocs-pure">Pure theme</a>
  
  </div>
</div>

</div>
</body>
</html>