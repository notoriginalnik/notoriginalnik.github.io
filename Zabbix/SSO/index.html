<!--
  This Basic theme serves as an example for how to create other
  themes by demonstrating the features with minimal HTML and CSS.
  Comments like this will be through the code to explain briefly
  what each feature is and point you to the MkDocs documentation
  to find out more.
-->
<!DOCTYPE html>
<head>
  
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <!--
    The page_title contains the title for a page as shown in the navigation.
    Site name contains the name as defined in the mkdocs.yml
  -->
  
  <title>SSO in zabbix - not name</title>
  
  <!--
    You can include external assets of course, but be aware that it means the
    documentation may not work well offline.
  -->
  <link rel="stylesheet" href="../../css/pure-min.css">
  <link rel="stylesheet" href="../../css/theme.css">

  <!--
    extra_ess contains paths to CSS files in the users
    documentation directory or a list of CSS files defined in
    their mkdocs.yml.

    http://www.mkdocs.org/user-guide/configuration/#extra_css
  -->
   
  
  
  
  
  
  
</head>

<body>

  <!--
  <h1>This is an example theme for MkDocs.</h1>

  <p>
    It is designed to be read by looking at the theme HTML which is heavily
    commented. The easiest way to do that is by
    <strong><a href="https://github.com/mkdocs/mkdocs-basic-theme/tree/master/basic_theme">
    looking at the source on GitHub.</a></strong>. Otherwise this is just a
    demonstration that the theme is fully functional.
  </p>

  <hr/>
  -->
  <!--
  <h2>Documentation Navigation</h2>
  -->
  <!--
    Create the navigation for the documentation.

    Because we don't know how many levels deep the navigation is, it needs to
    be included in it's own file so it can be recursive. Otherwise the theme
    can also only support a specific number of levels.

    See the nav.html file for more details about how this works.
  -->
  

<div id="layout">

    <!-- Menu toggle -->
  <h1 class="logo-text">
	<label for="toggler">
      <i class="fas fa-bars sidebar-toggle"></i>
    </label>
  </h1>
	
	<input type="checkbox" id="toggler"/>
    <div id="menu">
      <div class="pure-menu">
	  <a class="pure-menu-heading" href="../..">Home</a>
  <ul class="pure-menu-list">
  
    <!--

-->

  <li class="pure-menu-folder">
    Тренировки
    <ul>
        
            <!--

-->

<li >
    <a href="../../%D0%A2%D1%80%D0%B5%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8/%D0%A1%D0%B8%D0%BB%D0%BE%D0%B2%D1%8B%D0%B5%20%D1%82%D1%80%D0%B5%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8/" class="pure-menu-link">Силовые тренировки</a>
</li>

        
            <!--

-->

<li >
    <a href="../../%D0%A2%D1%80%D0%B5%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8/%D0%B2%D0%BE%D1%81%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5/" class="pure-menu-link">Восстановление</a>
</li>

        
            <!--

-->

<li >
    <a href="../../%D0%A2%D1%80%D0%B5%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8/%D0%B7%D0%B0%D1%80%D1%8F%D0%B4%D0%BA%D0%B0/" class="pure-menu-link">Зарядка</a>
</li>

        
            <!--

-->

<li >
    <a href="../../%D0%A2%D1%80%D0%B5%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8/%D1%80%D0%B0%D1%81%D1%82%D1%8F%D0%B6%D0%BA%D0%B0/" class="pure-menu-link">Статическая растяжка</a>
</li>

        
    </ul>
  </li>

  
    <!--

-->

  <li class="pure-menu-folder">
    Поход
    <ul>
        
            <!--

-->

<li >
    <a href="../../%D0%9F%D0%BE%D1%85%D0%BE%D0%B4/%D0%93%D0%B8%D0%B3%D0%B8%D0%B5%D0%BD%D0%B0/" class="pure-menu-link">Гигиена</a>
</li>

        
            <!--

-->

<li >
    <a href="../../%D0%9F%D0%BE%D1%85%D0%BE%D0%B4/%D0%9F%D0%B8%D1%82%D0%B0%D0%BD%D0%B8%D0%B5/" class="pure-menu-link">Питание</a>
</li>

        
    </ul>
  </li>

  
    <!--

-->

  <li class="pure-menu-folder">
    Питание
    <ul>
        
            <!--

-->

<li >
    <a href="../../%D0%9F%D0%B8%D1%82%D0%B0%D0%BD%D0%B8%D0%B5/%D0%91%D0%96%D0%A3/" class="pure-menu-link">БЖУ</a>
</li>

        
    </ul>
  </li>

  
    <!--

-->

  <li class="pure-menu-folder">
    Кинокаталог
    <ul>
        
            <!--

-->

<li >
    <a href="../../%D0%9A%D0%B8%D0%BD%D0%BE%D0%BA%D0%B0%D1%82%D0%B0%D0%BB%D0%BE%D0%B3/%D0%9C%D1%83%D0%BB%D1%8C%D1%82%D1%84%D0%B8%D0%BB%D1%8C%D0%BC%D1%8B/" class="pure-menu-link">Мультфильмы</a>
</li>

        
            <!--

-->

<li >
    <a href="../../%D0%9A%D0%B8%D0%BD%D0%BE%D0%BA%D0%B0%D1%82%D0%B0%D0%BB%D0%BE%D0%B3/%D0%A4%D0%B8%D0%BB%D1%8C%D0%BC%D1%8B/" class="pure-menu-link">Фильмы</a>
</li>

        
    </ul>
  </li>

  
    <!--

-->

  <li class="pure-menu-folder">
    Useful programs
    <ul>
        
            <!--

-->

<li >
    <a href="../../useful_programs/" class="pure-menu-link">useful opensource programms</a>
</li>

        
    </ul>
  </li>

  
    <!--

-->

  <li class="pure-menu-folder">
    Zabbix
    <ul>
        
            <!--

-->

<li >
    <a href="../Partitioning/" class="pure-menu-link">Partitioning with external script for mysql/mariadb database</a>
</li>

        
            <!--

-->

<li class="pure-menu-item">
    <a href="./" class="pure-menu-link">SSO in zabbix</a>
</li>

        
            <!--

-->

<li >
    <a href="../linux_template/" class="pure-menu-link">linux template</a>
</li>

        
            <!--

-->

<li >
    <a href="../mariadb/" class="pure-menu-link">Install mariadb node of galera + haproxy + keepalived</a>
</li>

        
            <!--

-->

<li >
    <a href="../mysql_monitoring/" class="pure-menu-link">Monitoring mysql/mariadb</a>
</li>

        
            <!--

-->

<li >
    <a href="../zabbix-agent/" class="pure-menu-link">install [zabbix-agent]</a>
</li>

        
            <!--

-->

<li >
    <a href="../zabbix-proxy/" class="pure-menu-link">Zabbix-proxy</a>
</li>

        
    </ul>
  </li>

  
    <!--

-->

  <li class="pure-menu-folder">
    Browser
    <ul>
        
            <!--

-->

<li >
    <a href="../../Browser/ublock/" class="pure-menu-link">uBlock Origin</a>
</li>

        
            <!--

-->

<li >
    <a href="../../Browser/%D0%98%D0%B7%D0%BC%D0%B5%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81%D0%B0/" class="pure-menu-link">Изменение интерфейса</a>
</li>

        
    </ul>
  </li>

  
    <!--

-->

<li >
    <a href="../.." class="pure-menu-link">Home</a>
</li>

  
  </ul>
      </div>
    </div>




<div id="main">
  <div class="content">
    
        <h1 id="sso-in-zabbix">SSO in zabbix</h1>
<ol>
<li>single sign-on (SSO)</li>
<li>SSL (Secure Sockets Layer - the level of protected cookes) is a cryptographic protocol for a safe connection.
From version 3.0 SSL replaced TLS (Transport Layer Security - transport level safety), but the name of the previous version has taken place.
Therefore, today under SSL most often implies TLS.</li>
<li>Works only with using domain name.</li>
</ol>
<h2 id="ldapldaps">LDAP/LDAPS</h2>
<p>Let us configure LDAP authentication in Zabbix. In the Zabbix frontend, go to the LDAP settings tab in Administration -&gt; Authentication.</p>
<p>Check Enable LDAP authentication and fill in the following fields:</p>
<pre><code>LDAP host: ldap://dc1.domain.local
Port: 389
Base DN: DC=domain, DC=local
Search attribute: sAMAccountName
Bind DN: CN=zabbix,OU=Users,DC=domain,DC=local
</code></pre>
<p>If the test has been successful, save the settings, and change the authentication type in Zabbix from Internal to LDAP</p>
<p>LDAP authentication is configured. If the LDAP server is unavailable, we will not be able to access Zabbix.</p>
<p>After Enable HTTP authentication (HTTP Settings -&gt; Enable HTTP authentication):
To get back to the internal authentication, we can open MySQL, and run the following command:
update zabbix.config set authentication_type='0' where configid='1?;</p>
<h2 id="dc">DC</h2>
<p>Create A record in dns and user in AD users, then:</p>
<pre><code class="language-cmd">ktpass -princ HTTP/zabbix.domain.local@DOMAIN.LOCAL -mapuser zabbix@DOMAIN.LOCAL -crypto all -pass VeryStrongPASS!!! -ptype KRB5_NT_PRINCIPAL -out my.keytab
</code></pre>
<p>If we want LDAPS, there need some settings on our DC:
https://social.technet.microsoft.com/wiki/contents/articles/2980.ldap-over-ssl-ldaps-certificate.aspx</p>
<p>WARNING: do not user IP addresses instead of hostnames/FQDNs, the value in LDAP host field must match what the server's certificate was issued for!
After transfer ca.cer on zabbix server convert cer extension to pem:</p>
<pre><code class="language-sh">openssl x509 -inform der -in ca-01.cer -out ca-01.pem
mv /tmp/ca-01.pem /etc/pki/ca-trust/source/anchors/
update-ca-trust
</code></pre>
<h2 id="kerberos">Kerberos</h2>
<p>For <a href="https://www.zabbix.com/documentation/current/manual/appendix/items/kerberos">Centos</a>:</p>
<pre><code class="language-sh">yum install krb5-workstation krb5-libs krb5-auth-dialog mod_auth_kerb ntp ntpdate -y
ntpdate DC1.domain.local
vi /etc/krb5.conf
</code></pre>
<p>Change next in /etc/krb5.conf:</p>
<pre><code class="language-conf">[realms]
 EXAMPLE.COM = {
  kdc = kerberos.example.com
 admin_server = kerberos.example.com
 }

[domain_realm]
 .example.com = EXAMPLE.COM
 example.com = EXAMPLE.COM
</code></pre>
<p>Restart Apache to take effect
specify the FQDN name of the server in /etc/hostname that must match the DNS record in the domain.</p>
<pre><code class="language-sh">cat /etc/hosts
127.0.0.1   zabbix.domain.local zabbix
'server ip' zabbix.domain.local zabbix
</code></pre>
<p>After copy keytab file from DC, we need check permission for this.</p>
<p>Command <code>klist</code> will show if the ticket was created.
Create a Kerberos ticket for user OR easy to check if your krb5.conf is valid by doing <code>kinit username@DOMAIN.COM</code>, for our example <code>kinit zabbix</code>.
Make sure the Kerberos authentication works on Linux:<code>kinit -kV -p HTTP/zabbix.domain.local</code>.
Delete tickets - <code>kdestroy -A</code>.</p>
<h2 id="web">web</h2>
<p>Enable HTTP authentication in zabbix, and im not think that change default login form is good for all. So i want work with link <code>/zabbix/index_http.php</code>.
For apache add next block in /etc/httpd/conf.d/zabbix.conf:</p>
<pre><code class="language-conf">&lt;Location /zabbix/index_http.php&gt;
        AuthType Kerberos
        AuthName &quot;Kerberos Authenticated&quot;
        KrbAuthRealms DOMAIN.LOCAL
        Krb5Keytab &quot;/etc/httpd/conf.d/zabbix.keytab&quot;
        KrbMethodNegotiate On
        KrbSaveCredentials On
        KrbVerifyKDC On
        KrbServiceName Any
        KrbLocalUserMapping On
        KrbMethodK5Passwd Off
        Require valid-user
#        LogLevel trace8
&lt;/Location&gt;
</code></pre>
<h2 id="browser">Browser</h2>
<p>For Internet Explorer to use Kerberos authentication on Zabbix, we will have to add its URL to Local Intranet sites.
Google Chrome uses Internet Explorer settings, so we do not need to configure it separately.
1. Open Options -&gt; Security in the IE.
1. Click Sites in the Local intranet, check the options shown in the screenshot below, and click Advanced:
1. Later, enter the Zabbix server URL.
1. Then, go to the Advanced tab and check Enable Integrated Windows Authentication.
1. Add the URL of the Zabbix server to the following parameters of about:config for Mozilla Firefox:</p>
<pre><code>network.automatic-ntlm-auth.trusted-uris
network.negotiate-auth.delegation-uris
network.negotiate-auth.trusted-uris
</code></pre>
<p>Also, we can also put Zabbix URL to the Local Intranet zone using the <a href="https://1cloud.ru/help/windows/gruppovye-politiki-active-directory">Group Policies</a> (Computer Configuration -&gt; Administrative Templates -&gt; Windows Components -&gt; Internet Explorer -&gt; Internet Control Panel -&gt; Security Page -&gt; Site to Zone Assignment List. Use zone code 1 for intranet sites).</p>
<h2 id="debug">debug</h2>
<h3 id="kerberos-authentication-debugging-troubleshooting-in-apache">Kerberos Authentication Debugging &amp; Troubleshooting in Apache</h3>
<p>If we have any issues, enable debug mode in apache:
Enter the following before the closing </VirtualHost> tag in /etc/apache2/sites-available/000-defaults.conf:</p>
<p>LogLevel trace8</p>
<p>Then we restart apache and check the Kerberos module error in the error.log file.</p>
<p>To make it more convenient, we use the command to filter the entries by the IP address:</p>
<pre><code class="language-sh">tailf /var/log/httpd/error_log | grep 'our ip'
tail -f /var/log/apache2/error.log | grep 'Our IP address'
</code></pre>
<p>Similarly, to work with and diagnose Kerberos, we can use kinit and klist commands.
kinit is a tool to get and cache Kerberos tickets, for example:
<code>kinit -V -k -t /etc/apache2/zabbix.keytab -p HTTP/zabbix.domain.local@DOMAIN.LOCAL</code>
If we have generated our keytab file correctly, the command will run. 
As a result, we will get a message that the authentication has been successful.</p>
<p>Using klist, we can view cached Kerberos tickets:
klist -a</p>
<p>Make sure that the SPN record for your Zabbix service account exists in AD. Enter the following command on the domain controller:</p>
<p><code>setpn -l zabbix_admin</code></p>
<p>It must be in HTTP/zabbix.domain.local format. If there is no entry, add it.</p>
<p><code>setspn -a HTTP/zabbix.domain.local zabbix_admin</code></p>
<p>If KrbServiceName does not match the name specified in the keyboard file, an error occurs. So you can set the desired value during the test. Once you have made sure that the system is working, enter a valid service name. You can check with:
klist - the /etc/apache2/zabbix.keytab</p>
<h3 id="notes">Notes</h3>
<p>A successful request should look like:</p>
<pre><code>Acquiring creds for HTTP/web01@DOMAIN.NET
Verifying client data using KRB5 GSS-API
Client didn't delegate us their credential
GSS-API token of length XXX bytes will be sent back
</code></pre>
<p>.</p>
<pre><code>gss_accept_sec_context() failed: An unsupported mechanism was requested (, Unknown error)
</code></pre>
<p>This usually means there's something wrong with the principal configuration.</p>
<pre><code>GSS-API major_status:000d0000, minor_status:025ea101
</code></pre>
<p>Could no find principal. Spelling error or wrong syntax ?</p>
<pre><code>GSS-API major_status:000d0000, minor_status:0000000d
</code></pre>
<p>File permission errors (usually the keytab file).</p>
<pre><code>GSS-API major_status:000d0000, minor_status:000186a3
</code></pre>
<p>Wrong password in keytab or your ticket.</p>
<pre><code>kinit: Preauthentication failed while getting initial credentials
</code></pre>
<p>Wrong password and/or credentials in general (check letter casing)</p>
<pre><code>kinit: KDC has no support for encryption type while getting initial credentials
</code></pre>
<p>Encryption type is not supported by the AD server. Make sure not to use DES.</p>
<pre><code>Users not getting synced
</code></pre>
<p>Make sure the users are as low in the hierarchy as possible or else they might not get caught.</p>
<pre><code>General authentication errors
</code></pre>
<p>Make sure you're typing the login in correct case. They also have to match in the keytab file.</p>
<h2 id="some-links">Some links</h2>
<p>Nice one <a href="http://woshub.com/zabbix-single-sign-sso-authentication-ldap-active-directory/">http://woshub.com/zabbix-single-sign-sso-authentication-ldap-active-directory/</a></p>
<h3 id="for-debugging">For debugging</h3>
<ol>
<li>https://gist.github.com/andersevenrud/53920c3ef91c5e11c939fce5ca17af3b</li>
<li>https://plugins.miniorange.com/guide-to-setup-kerberos-single-sign-sso</li>
<li>https://www.drupal.org/project/ldap/issues/2123615</li>
<li>https://jakondo.ru/integratsiya-zabbix-s-active-directory-nastrojka-prozrachnoj-autentifikatsii-sso-single-sign-on/</li>
<li>https://jakondo.ru/nastrojka-sso-single-sign-on-avtorizatsii-na-apache-v-active-directory-debian-8-jessie-ubuntu-server-14-04/</li>
</ol>
<h3 id="ldaps">LDAPS</h3>
<ol>
<li>https://techcommunity.microsoft.com/t5/sql-server/step-by-step-guide-to-setup-ldaps-on-windows-server/ba-p/385362</li>
<li>https://winitpro.ru/index.php/2014/10/02/aktiviruem-ldap-over-ssl-ldaps-v-windows-server-2012-r2/</li>
<li>https://winitpro.ru/index.php/2015/11/02/ustanovka-sertifikata-na-kompyutery-domena-s-pomoshhyu-gruppovyx-politik/</li>
<li>https://denisitpro.wordpress.com/2019/02/02/ldaps-tls-ssl/</li>
<li>https://bgmot.com/zabbix_secure_ldap</li>
</ol>
    
    



  <!--  
  <h2>Next and previous links</h2>

    Implement the previous and next links to cycle through the pages.
  -->

    
    
    <nav class="pagination">
      
        <a href="../Partitioning/" class="pagination--pager" title="Partitioning with external script for mysql/mariadb database">&laquo; Previous</a>
      
      
      
        <a href="../linux_template/"  class="pagination--pager" title="linux template"/>Next &raquo;</a>
      
    </nav>
    
    



  <!--
    Support repo URL
  -->
  
  
   Built on <a href="https://github.com/notoriginalnik/notoriginalnik.github.io">GitHub</a>
  
  
  
   with <a href="https://www.mkdocs.org">MkDocs</a> and <a href="https://github.com/notoriginalnik/mkdocs-pure">Pure theme</a>
  
  </div>
</div>

</div>
</body>
</html>